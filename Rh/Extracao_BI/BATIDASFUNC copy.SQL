SELECT
	INSTANCIA = <<INSTANCIA>>
	,PKCHAPA = CONVERT(VARCHAR, ABATFUN.CODCOLIGADA) + '_' + UPPER(CONVERT(VARCHAR(25), PFUNC.CHAPA))
	,FKCODCOLIGADA = CONVERT(VARCHAR,GCOLIGADA.CODCOLIGADA)
	,[Batidas do Funcionario] = UPPER(ISNULL(CONVERT(VARCHAR(255), ABATFUN .BATIDA), 'N/A'))
	,[Data da Batida] = CONVERT(VARCHAR(10), ABATFUN.DATA, 112)
	,[Natureza] = UPPER(CONVERT(VARCHAR(25), ABATFUN.NATUREZA))
	,[ID da Batida] = UPPER(CONVERT(VARCHAR(25), ABATFUN.IDAAFDT))
	,ROW_NUMBER()
		OVER (
			PARTITION BY ABATFUN.CODCOLIGADA, PFUNC.CHAPA, ABATFUN.DATA
			ORDER BY ABATFUN.BATIDA) AS NUM_LINHA
	,[Status da Batida] = UPPER(CONVERT(VARCHAR(25), ABATFUN.STATUS))
    ,[Status Ultima Batida] = CASE
                                  WHEN LEAD([Natureza], 1)
                                         OVER (
                                           PARTITION BY ABATFUN.CODCOLIGADA, PFUNC.CHAPA, ABATFUN.DATA
                                           ORDER BY ABATFUN.BATIDA DESC) = 0 THEN '1'
                                  ELSE '0'
                                END
FROM   ABATFUN (NOLOCK)
       INNER JOIN GCOLIGADA
               ON GCOLIGADA.CODCOLIGADA = ABATFUN.CODCOLIGADA
       LEFT JOIN PFUNC
              ON PFUNC.CHAPA = ABATFUN.CHAPA
                 AND PFUNC.CODCOLIGADA = ABATFUN.CODCOLIGADA; 
Z